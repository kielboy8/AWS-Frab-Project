AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'frab-api

  Sample SAM Template for frab-api

  '
Globals:
  Function:
    Timeout: 3
Parameters:
  BookingQueueExpiration:
    Type: Number
    Default: 120
  DefaultRegion:
    Type: String
    Default: ap-southeast-1
Resources:
  FrabApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors: '''*'''
      Auth:
        DefaultAuthorizer: LambdaTokenAuthorizerFunction
        Authorizers:
          LambdaTokenAuthorizerFunction:
            FunctionArn:
              Fn::GetAtt:
              - LambdaTokenAuthorizerFunction
              - Arn
      GatewayResponses:
        UNAUTHORIZED:
          StatusCode: 401
          ResponseParameters:
            Headers:
              Access-Control-Expose-Headers: '''WWW-Authenticate'''
              Access-Control-Allow-Origin: '''*'''
              WWW-Authenticate: '''Authorization'''
  LambdaTokenAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://frab-api-artifact/cc8ff246447d317b8773fdf49c7b55ac
      Handler: app.handler
      Runtime: nodejs10.x
  GetRidesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://frab-api-artifact/43d923b9c0563a33685eaaa65445a9f1
      Handler: app.lambda_handler
      Runtime: python3.7
      Events:
        FrabApi:
          Type: Api
          Properties:
            Path: /drivers/{driverId}/rides/
            Method: get
            RestApiId:
              Ref: FrabApi
      Environment:
        Variables:
          DEFAULT_REGION:
            Ref: DefaultRegion
          BOOKING_QUEUE:
            Ref: BookingQueue
      Policies:
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - BookingQueue
            - QueueName
  BookingQueue:
    Type: AWS::SQS::Queue
    Properties:
      ContentBasedDeduplication: true
      QueueName: BookingQueue.fifo
      FifoQueue: true
      ReceiveMessageWaitTimeSeconds: 1
      VisibilityTimeout: 1
      MessageRetentionPeriod:
        Ref: BookingQueueExpiration
  GetRideFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://frab-api-artifact/c4abe656961cf71586ca875894698796
      Handler: app.lambda_handler
      Runtime: python3.7
      Events:
        FrabApi:
          Type: Api
          Properties:
            Path: /rides/{rideId}
            Method: get
            RestApiId:
              Ref: FrabApi
      Environment:
        Variables:
          DEFAULT_REGION:
            Ref: DefaultRegion
          RIDES_TABLE:
            Fn::Select:
            - 1
            - Fn::Split:
              - /
              - Fn::GetAtt:
                - RidesTable
                - Arn
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: RidesTable
  BookRideFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://frab-api-artifact/0fc67f74cbcddf79b436ff9226825a16
      Handler: app.lambda_handler
      Runtime: python3.7
      Events:
        FrabApi:
          Type: Api
          Properties:
            Path: /rides
            Method: post
            RestApiId:
              Ref: FrabApi
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: RidesTable
      - SQSSendMessagePolicy:
          QueueName:
            Fn::GetAtt:
            - BookingQueue
            - QueueName
      Environment:
        Variables:
          DEFAULT_REGION:
            Ref: DefaultRegion
          BOOKING_QUEUE:
            Ref: BookingQueue
          RIDES_TABLE:
            Fn::Select:
            - 1
            - Fn::Split:
              - /
              - Fn::GetAtt:
                - RidesTable
                - Arn
  AcceptRideRequestFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://frab-api-artifact/0f7f09004455d46c878b581cee0c85b8
      Handler: app.lambda_handler
      Runtime: python3.7
      Events:
        FrabApi:
          Type: Api
          Properties:
            Path: /drivers/{driverId}/rides/{rideId}
            Method: put
            RestApiId:
              Ref: FrabApi
      Environment:
        Variables:
          DEFAULT_REGION:
            Ref: DefaultRegion
          RIDES_TABLE:
            Fn::Select:
            - 1
            - Fn::Split:
              - /
              - Fn::GetAtt:
                - RidesTable
                - Arn
          DRIVERS_TABLE:
            Fn::Select:
            - 1
            - Fn::Split:
              - /
              - Fn::GetAtt:
                - DriversTable
                - Arn
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: RidesTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DriversTable
  LocationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://frab-api-artifact/6fafb0ce6a02c2eb2bff65cff2da2d4a
      Handler: app.lambda_handler
      Runtime: python3.7
      Events:
        Location:
          Type: Api
          Properties:
            Path: /drivers/{driverId}/locations
            Method: put
            RestApiId:
              Ref: FrabApi
      Environment:
        Variables:
          DRIVERS_TABLE:
            Fn::Select:
            - 1
            - Fn::Split:
              - /
              - Fn::GetAtt:
                - DriversTable
                - Arn
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: DriversTable
  RidesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: ride_id
        AttributeType: S
      KeySchema:
      - AttributeName: ride_id
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  DriversTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: driver_id
        AttributeType: S
      KeySchema:
      - AttributeName: driver_id
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
Outputs:
  FrabApi:
    Description: API Gateway endpoint URL for Prod stage for Book Ride function
    Value:
      Fn::Sub: https://${FrabApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/rides/
  BookRideFunction:
    Description: BookRideFunction Lambda Function ARN
    Value:
      Fn::GetAtt:
      - BookRideFunction
      - Arn
  BookRideFunctionIamRole:
    Description: Implicit IAM Role created for Hello World function
    Value:
      Fn::GetAtt:
      - BookRideFunctionRole
      - Arn
